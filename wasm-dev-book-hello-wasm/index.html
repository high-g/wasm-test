<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>Hello, Wasm!!</title>
  </head>
  <body>
    <script>
      const imports = {
        env: {
          date_now: Date.now,
        },
      }

      const wasm = './target/wasm32-unknown-unknown/release/wasm_dev_book_hello_wasm.wasm'

      const toUnit32 = (num) => num >>> 0

      // const importObject = { imports: { imported_func: (arg) => console.log(arg) } }

      WebAssembly.instantiateStreaming(fetch(wasm), imports).then((results) => {
        console.log('---------- wasm loop 処理計測 ----------')
        const startTime = performance.now()
        const { heavy_loop } = results.instance.exports
        const res = heavy_loop()
        const endTime = performance.now()
        console.log('wasm 10億回ループの経過ミリ秒', endTime - startTime)
        console.log('res', res)
      })

      // fetch(wasm)
      //   .then((response) => response.arrayBuffer())
      //   .then((bytes) => WebAssembly.instantiate(bytes, imports))
      //   .then((results) => {
      //     const { add, get_timestamp, rand } = results.instance.exports
      //     console.log(add(1, 2))
      //     console.log('get_timestamp()', get_timestamp())
      //     console.log('rand', toUnit32(rand()))
      //   })

      console.log('---------- js loop(for) 処理計測 ----------')
      const startTimeFor = performance.now()
      for (let i = 0; i < 100000000; i++) {}
      const endTimeFor = performance.now()
      console.log('js forでの1億回ループの経過ミリ秒', endTimeFor - startTimeFor)

      console.log('---------- js loop(while) 処理計測 ----------')
      const startTimeWhile = performance.now()
      let i = 0
      while (i < 100000000) {
        i++
      }
      const endTimeWhile = performance.now()
      console.log('js whileでの1億回ループの経過ミリ秒', endTimeWhile - startTimeWhile)
    </script>
    wasmチェック
  </body>
</html>
